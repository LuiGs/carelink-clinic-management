// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Roles de usuario del sistema
enum Role {
  PROFESIONAL
  MESA_ENTRADA
  GERENTE
}

// Modelo de usuario con autenticación básica y rol
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String
  role          Role      @default(MESA_ENTRADA)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]

  // Relaciones con pacientes y turnos
  createdPatients     Patient[]      @relation("PatientCreator")
  professionalAppointments Appointment[] @relation("ProfesionalAppointments")
  createdAppointments      Appointment[] @relation("CreatorAppointments")

  diagnoses           Diagnosis[]        @relation("DiagnosisProfessional")
  prescriptions       Prescription[]     @relation("PrescriptionProfessional")
  studyOrders         StudyOrder[]       @relation("StudyOrderProfessional")
  recordedMedications PatientMedication[] @relation("MedicationProfessional")

  // --- Auditoría de Especialidad (agregado) ---
  especialidadesCreadas      Especialidad[]            @relation("EspecialidadCreatedBy")
  especialidadesActualizadas Especialidad[]            @relation("EspecialidadUpdatedBy")
  especialidadesDesactivadas Especialidad[]            @relation("EspecialidadDeactivatedBy")
  AppointmentCancellation    AppointmentCancellation[]

  @@map("users")
}

// Sesiones simples basadas en token para manejo de login
model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@map("sessions")
}

// Obras sociales disponibles en Argentina
model ObraSocial {
  id          String    @id @default(cuid())
  nombre      String    @unique
  codigo      String?   @unique
  activa      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("obras_sociales")
}

// Modelo de paciente con campos específicos para Argentina
model Patient {
  id              String      @id @default(cuid())
  // Datos personales
  nombre          String
  apellido        String
  dni             String      @unique
  fechaNacimiento DateTime
  genero          String      // M, F, Otro
  telefono        String?
  celular         String?
  email           String?
  
  
  // Dirección
  direccion       String?
  ciudad          String?
  provincia       String?
  codigoPostal    String?
  
  // Contacto de emergencia
  contactoEmergenciaNombre    String?
  contactoEmergenciaTelefono  String?
  contactoEmergenciaRelacion  String?
  
  // Sistema
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  createdBy       String      // ID del usuario que creó el paciente
  creator         User        @relation("PatientCreator", fields: [createdBy], references: [id])
  
  // Turnos
  appointments            Appointment[]
  AppointmentCancellation AppointmentCancellation[]
  diagnoses               Diagnosis[]
  prescriptions           Prescription[]
  studyOrders             StudyOrder[]
  medications             PatientMedication[]

  @@map("patients")
}

// Estados posibles de un turno
enum AppointmentStatus {
  PROGRAMADO
  CONFIRMADO
  EN_SALA_DE_ESPERA
  COMPLETADO
  CANCELADO
  NO_ASISTIO
}

// Modelo de turnos/citas
model Appointment {
  id            String            @id @default(cuid())
  fecha         DateTime
  duracion      Int               @default(30) // minutos
  motivo        String?
  observaciones String?
  estado        AppointmentStatus @default(PROGRAMADO)
  
  // TODO: Campos para obra social específicos del turno
  // Estos campos se agregarán cuando se implemente la funcionalidad de turnos:
  // obraSocialId         String?          // Obra social al momento del turno
  // numeroAfiliado       String?          // Número de afiliado al momento del turno  
  // tipoConsulta         String?          // Particular, Obra Social, etc.
  // copago              Decimal?         // Monto de copago si aplica
  // autorizacion        String?          // Número de autorización de obra social
  
  // Relaciones
  pacienteId    String
  paciente      Patient          @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  profesionalId String
  profesional   User    @relation("ProfesionalAppointments", fields: [profesionalId], references: [id])
  createdBy     String // Usuario que creó el turno (mesa de entrada)
  creator       User    @relation("CreatorAppointments", fields: [createdBy], references: [id])

  // Relación con obra social
  obraSocial ObraSocial? @relation(fields: [obraSocialId], references: [id])

  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  AppointmentCancellation AppointmentCancellation?
  diagnoses               Diagnosis[]
  prescriptions           Prescription[]
  studyOrders             StudyOrder[]

  @@map("appointments")
}

model AppointmentCancellation {
  id String @id @default(cuid())

  // Relación al turno
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  // Relación al paciente del turno
  pacienteId String
  paciente   Patient @relation(fields: [pacienteId], references: [id])

  // Usuario que confirma la cancelación
  cancelledById String
  cancelledBy   User   @relation(fields: [cancelledById], references: [id])

  motivo      String
  cancelledAt DateTime @default(now())

  @@map("appointment_cancellations")
}

// ================== Especialidad (agregado) ==================
model Especialidad {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?
  activa      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relación con usuarios profesionales
  professionals User[] @relation("UserEspecialidad")

  // Auditoría
  createdById     String?
  updatedById     String?
  deactivatedById String?
  deactivatedAt   DateTime?

  createdBy     User? @relation("EspecialidadCreatedBy", fields: [createdById], references: [id])
  updatedBy     User? @relation("EspecialidadUpdatedBy", fields: [updatedById], references: [id])
  deactivatedBy User? @relation("EspecialidadDeactivatedBy", fields: [deactivatedById], references: [id])

  @@map("especialidades")
}

// Días de la semana para horarios
enum DayOfWeek {
  LUNES
  MARTES
  MIERCOLES
  JUEVES
  VIERNES
  SABADO
  DOMINGO
}

// Horarios de disponibilidad de profesionales
model ProfessionalSchedule {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  dayOfWeek DayOfWeek
  startTime String    // Formato HH:mm (ej: "09:00")
  endTime   String    // Formato HH:mm (ej: "17:00")
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId, dayOfWeek])
  @@map("professional_schedules")
}

model Diagnosis {
  id             String       @id @default(cuid())
  appointmentId  String
  appointment    Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patientId      String
  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId String
  professional   User         @relation("DiagnosisProfessional", fields: [professionalId], references: [id])
  principal      String
  secundarios    String[]     @default([])
  notas          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  prescriptions PrescriptionDiagnosis[]

  @@map("diagnoses")
}

model Prescription {
  id             String       @id @default(cuid())
  appointmentId  String
  appointment    Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patientId      String
  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId String
  professional   User         @relation("PrescriptionProfessional", fields: [professionalId], references: [id])
  notas          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  items       PrescriptionItem[]
  diagnoses   PrescriptionDiagnosis[]

  @@map("prescriptions")
}

model PrescriptionItem {
  id              String        @id @default(cuid())
  prescriptionId  String
  prescription    Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medicamento     String
  dosis           String
  frecuencia      String
  duracion        String
  indicaciones    String?

  @@map("prescription_items")
}

model PrescriptionDiagnosis {
  id             String        @id @default(cuid())
  prescriptionId String
  diagnosisId    String
  prescription   Prescription  @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  diagnosis      Diagnosis     @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)

  @@unique([prescriptionId, diagnosisId])
  @@map("prescription_diagnoses")
}

model StudyOrder {
  id             String       @id @default(cuid())
  appointmentId  String
  appointment    Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  patientId      String
  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId String
  professional   User         @relation("StudyOrderProfessional", fields: [professionalId], references: [id])
  notas          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  items StudyOrderItem[]

  @@map("study_orders")
}

model StudyOrderItem {
  id         String     @id @default(cuid())
  orderId    String
  order      StudyOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  estudio    String
  indicaciones String?

  @@map("study_order_items")
}

model PatientMedication {
  id             String   @id @default(cuid())
  patientId      String
  patient        Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  professionalId String
  professional   User     @relation("MedicationProfessional", fields: [professionalId], references: [id])
  nombre         String
  dosis          String?
  frecuencia     String?
  viaAdministracion String?
  fechaInicio    DateTime?
  fechaFin       DateTime?
  indicaciones   String?
  activo         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("patient_medications")
}
